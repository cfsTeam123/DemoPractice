@using BISTAC.Models;
@model BISTAC.Models.IndexValidation
@{
    BISTACEntities conn = new BISTACEntities();
    ViewBag.Title = "";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int UserNo = Convert.ToByte(Session["Userid"]);
    string UserType = Convert.ToString(Session["UserType"]);
    var user = conn.UserMasters.Where(x => x.MTransNo == UserNo).FirstOrDefault();


    var UserLisr = (from B in conn.UserMasters
                    where B.MTransNo != UserNo
                    select new
                    {
                        MTransNo = B.MTransNo,
                        UserType = B.UserType,
                        MsgCount = (from M in conn.EMSMsgs where M.Sender == B.MTransNo && M.MsgStatus == "Read" select M.MTransNo).Count(),
                        UserId = B.UserId
                    }).OrderByDescending(x => x.MsgCount).ThenBy(x => x.UserId).ToList();

    var RunningPList = conn.WOMsts
    .Where(x => x.DeleteStatus == "N" && x.LockStatus == "Y" && x.ProStatus.Trim() == "InProcess")
    .ToList()
    .GroupBy(x => x.DocNo)
    .Select(g => g.First())
    .OrderBy(x => x.DocNo)
    .ToList();

    var ServicePList = conn.WOMsts
        .Where(x => x.DeleteStatus == "N" && x.LockStatus == "Y" && x.ProStatus.Trim() == "InService")
        .ToList()
        .GroupBy(x => x.DocNo)
        .Select(g => g.First())
        .OrderBy(x => x.DocNo)
        .ToList();


}
<style>

    thead {
        position: sticky;
        top: 0;
        background-color: #f1f1f1;
        z-index: 1; /* Ensure the header stays on top of the table rows */
    }

    th {
        text-align: center;
        color: black; /* Set text color to black */
        font-weight: bold; /* Make text bold */
        text-align: center; /* Center-align the text */
    }

    tableSearch,
    tableSearch2 {
        position: sticky;
    }
</style>

<style>
    body1 {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden; /* Prevent horizontal scroll */
    }


    .order-progress {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        font-family: 'Segoe UI', sans-serif;
        animation: fadeInUp 0.6s ease;
    }

    @@keyframes fadeInUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .order-progress .card-header {
        background: linear-gradient(135deg, #4e73df, #1cc88a);
        color: white;
        padding: 20px;
        font-size: 1.5rem;
        font-weight: 600;
        border-bottom: none;
    }

    .order-progress .card-header {
        background: linear-gradient(135deg, #4e73df, #1cc88a);
        color: white;
        padding: 20px;
        font-size: 1.5rem;
        font-weight: 600;
        border-bottom: none;
    }

    .card-header1 {
        background: linear-gradient(135deg, #4e73df, #f3751b);
        color: white;
        padding: 20px;
        font-size: 1.5rem;
        font-weight: 600;
        border-bottom: none;
    }

    .order-progress .card-body {
        padding: 20px;
    }

    #tableSearch,
    #tableSearch2 {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 18px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        transition: 0.3s ease;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }

        #tableSearch:focus,
        #tableSearch2:focus{
            border-color: #4e73df;
            box-shadow: 0 0 6px rgba(78, 115, 223, 0.3);
            background: #fff;
        }

    .scrollable-table {
        max-height: 350px;
        min-height: 350px;
        overflow-y: auto;
        border-radius: 8px;
        scrollbar-width: thin;
    }

        .scrollable-table::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-table::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 6px;
        }

    table.table-modern {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        color: #333;
    }

        table.table-modern thead {
            background: #f8f9fc;
        }

        table.table-modern th,
        table.table-modern td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e3e6f0;
        }

        table.table-modern tbody tr {
            transition: background 0.3s ease, transform 0.2s ease;
        }

            table.table-modern tbody tr:hover {
                background: #f1f5ff;
                transform: scale(1.01);
            }

    .delay-high {
        color: #e74a3b; /* red */
        font-weight: 700;
        animation: blink 1s infinite alternate;
    }
    .delay-ok {
        color: #28a745; /* green */
        font-weight: bold;
    }

    @@keyframes blink {
        0% {
            opacity: 1;
        }

        100% {
            opacity: 0.7;
        }
    }

    .custom-label {
        font-weight: 600;
        font-size: 16px;
        color: #2c3e50;
    }

    .custom-dropdown {
        border: 2px solid #3498db;
        border-radius: 6px;
        font-weight: 600;
        color: #2c3e50;
        background-color: #ecf0f1;
        padding: 6px 12px;
        transition: all 0.3s ease-in-out;
    }

        .custom-dropdown:focus {
            border-color: #2980b9;
            box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
            background-color: #ffffff;
        }

    .styled-label {
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
    }

    .styled-select {
        appearance: none;
        background-color: #f1f9ff;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 15px;
        font-weight: 600;
        color: #34495e;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%233498db" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px 16px;
    }

        .styled-select:focus {
            outline: none;
            border-color: #1abc9c;
            box-shadow: 0 0 5px rgba(26, 188, 156, 0.5);
            background-color: #ffffff;
        }
</style>


<!-- Add DataTables CSS -->
<link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

<!-- Add jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Add DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

@*Blink*@
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<body style="margin: 0; width: 100%;">
    <section id="body1" class="content-wrapper" style="width:100vw; height:100vh; overflow: auto;">

        <section role="main" class="content-body">
            <header class="page-header">
                <h2>Home</h2>
            </header>
            <br />
            <div class="form-group row" style="margin-top: 65px;">
                <div class="col-lg-6">
                    <div class="order-progress">
                        <header class="card-header">
                            Running Projects
                        </header>
                        <div class="card-body">
                            <input type="text" id="tableSearch" placeholder="🔍 Search anything..." onkeyup="searchTable()" />
                            <div class="scrollable-table">
                                <table class="table-modern" id="myTable">
                                    <thead>
                                        <tr>
                                            <th>SlNo</th>
                                            <th>OA No</th>
                                            <th>OA Date</th>
                                            <th>WO Release Date</th>
                                            <th>WO Due Date</th>
                                            <th>Delay Days(int)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableCont">
                                        @{
                                            int rowNo = 0;
                                            string delayClass = "delay-high";
                                            foreach (var item in RunningPList)
                                            {
                                                int delayDays = 0;
                                                DateTime? dueDate = item.WODueDate;
                                                DateTime? docDate = item.DocDate;
                                                if (dueDate != null)
                                                {
                                                    delayDays = (DateTime.UtcNow.AddHours(5).AddMinutes(30).Date - dueDate.Value.Date).Days;
                                                    if (delayDays < 0) { delayDays = 0; }
                                                }

                                                <tr>
                                                    <td>@(++rowNo)</td>
                                                    <td>@item.DocNo</td>
                                                    <td>@string.Format("{0:dd-MM-yyyy}", item.OADate)</td>
                                                    <td>@(docDate.HasValue ? docDate.Value.ToString("dd-MM-yyyy") : "")</td>
                                                    <td>@(dueDate.HasValue ? dueDate.Value.ToString("dd-MM-yyyy") : "")</td>
                                                    @if (delayDays > 0)
                                                    {
                                                        <td class="@delayClass">@delayDays</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="order-progress">
                        <header class="card-header">
                            AMC/Service Projects
                        </header>
                        <div class="card-body">
                            <input type="text" id="tableSearch2" placeholder="🔍 Search anything..." onkeyup="searchTable2()" />
                            <div class="scrollable-table">
                                <table class="table-modern" id="myTable2">
                                    <thead>
                                        <tr>
                                            <th>SlNo</th>
                                            <th>OA No</th>
                                            <th>OA Date</th>
                                            <th>WO Release Date</th>
                                            <th>WO Due Date</th>
                                            <th>Delay Days</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableCont">
                                        @{
                                            int rowNo2 = 0;
                                            delayClass = "delay-high";
                                            foreach (var item in ServicePList)
                                            {
                                                int delayDays = 0;
                                                DateTime? dueDate = item.WODueDate;
                                                DateTime? docDate = item.DocDate;
                                                if (dueDate != null)
                                                {
                                                    delayDays = (DateTime.UtcNow.AddHours(5).AddMinutes(30).Date - dueDate.Value.Date).Days;
                                                    if (delayDays < 0) { delayDays = 0; }
                                                }

                                                <tr>
                                                    <td>@(++rowNo2)</td>
                                                    <td>@item.DocNo</td>
                                                    <td>@string.Format("{0:dd-MM-yyyy}", item.OADate)</td>
                                                    <td>@(docDate.HasValue ? docDate.Value.ToString("dd-MM-yyyy") : "")</td>
                                                    <td>@(dueDate.HasValue ? dueDate.Value.ToString("dd-MM-yyyy") : "")</td>
                                                    @if (delayDays > 0)
                                                    {
                                                        <td class="@delayClass">@delayDays</td>
                                                    }
                                                    else
                                                    {
                                                        <td></td>
                                                    }
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg-12">
                    <div class="order-progress">
                        <header class="card-header1">
                            KOM Project Stages
                        </header>
                        <div class="card-body">
                            <div class="form-group row" style="height:50px;">
                                @Html.HiddenFor(model => model.MTransNo)
                                <label class="col-lg-2 col-form-label text-lg-right pt-1 custom-label">
                                    <span class="required text-danger">*</span>OA NO.
                                </label>
                                <div class="col-lg-2">
                                    @Html.DropDownListFor(model => model.OANo, null, "", new { @class = "form-control", data_plugin_selecttwo = "" })
                                    @Html.ValidationMessageFor(model => model.OANo, "", new { style = "color: red" })
                                </div>
                            </div>

                            <div class="scrollable-table">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Sl No</th>
                                            <th>Department</th>
                                            <th>Project Stage</th>
                                            <th>Commit Start Date</th>
                                            <th>Commit End Date</th>
                                            <th>Actual Start Date</th>
                                            <th>Actual End Date</th>
                                            <th>Remarks</th>
                                            <th>User Name</th>
                                            <th>Starting Delay Days</th>
                                            <th>Ending Delay Days</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableCont1">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>
</body>
<script>
    var latLog = "";
    var ipAdd = "";
</script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        
    });
</script>

<script>
    $(function () {
        $('#OANo').change(function () {
            let mOANo = $('#OANo').val();
            $.ajax({
                type: "POST",
                url: "/Home/FetchDetails",
                dataType: "json",
                data: { OANo: mOANo },
                success: function (result) {
                    $('#tableCont1').empty(); // Clear old rows

                    $.each(result, function (index, item) {
                        const commStart = formatDate(item.CommDate);
                        const commEnd = formatDate(item.CommEndDate);
                        const actStart = formatDate(item.StartDate);
                        const actEnd = formatDate(item.EndDate);

                        const commStartDate = parseJsonDate(item.CommDate);
                        const commEndDate = parseJsonDate(item.CommEndDate);
                        const actStartDate = parseJsonDate(item.StartDate);
                        const actEndDate = parseJsonDate(item.EndDate);

                        let delayStart = '';
                        let delayEnd = '';
                        let delayStartClass = '';
                        let delayEndClass = '';

                        // Calculate delay for Start Date
                        if (commStartDate && actStartDate) {
                            const delay = Math.ceil((actStartDate - commStartDate) / (1000 * 60 * 60 * 24));
                            if (delay > 0) {
                                delayStart = delay;
                                delayStartClass = 'delay-high'; // red blink
                            } else {
                                delayStart = '0'; // green tick
                                delayStartClass = 'delay-ok'; // green color
                            }
                        }

                        // Calculate delay for End Date
                        if (commEndDate && actEndDate) {
                            const delay = Math.ceil((actEndDate - commEndDate) / (1000 * 60 * 60 * 24));
                            if (delay > 0) {
                                delayEnd = delay;
                                delayEndClass = 'delay-high'; // red blink
                            } else {
                                delayEnd = '0'; // green tick
                                delayEndClass = 'delay-ok'; // green color
                            }
                        }

                        const row = `
                            <tr class="data-row">
                                <td>${index + 1}</td>
                                <td>${item.Department}</td>
                                <td>${item.ProjectStage}</td>
                                <td>${commStart}</td>
                                <td>${commEnd}</td>
                                <td>${actStart}</td>
                                <td>${actEnd}</td>
                               <td>${item.PrjRemarks ? item.PrjRemarks : ''}</td>
                                <td>${item.UserName}</td>
                                 <td class="${delayStartClass}">${delayStart}</td>
                                 <td class="${delayEndClass}">${delayEnd}</td>
                            </tr>`;
                        $('#tableCont1').append(row);
                    });
                },
                error: function (xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
    });

    function formatDate(jsonDate) {
        if (!jsonDate) return '';
        const date = new Date(parseInt(jsonDate.replace("/Date(", "").replace(")/", ""), 10));
        const day = ('0' + date.getDate()).slice(-2);
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        return `${day}-${month}-${date.getFullYear()}`;
    }

    // Extracts Date object from JSON date
    function parseJsonDate(jsonDate) {
        if (!jsonDate) return null;
        return new Date(parseInt(jsonDate.replace("/Date(", "").replace(")/", ""), 10));
    }

    function searchTable() {
        const input = document.getElementById("tableSearch");
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll("#myTable tbody tr");

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    }
    function searchTable2() {
        const input = document.getElementById("tableSearch2");
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll("#myTable2 tbody tr");

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    }

</script>
@*@Html.Partial("_jsfooter")*@


<!-- Specific Page Vendor -->
<script src="~/Content/vendor/jquery-ui/jquery-ui.js"></script>
<script src="~/Content/vendor/jqueryui-touch-punch/jqueryui-touch-punch.js"></script>
<script src="~/Content/vendor/jquery-appear/jquery-appear.js"></script>
<script src="~/Content/vendor/jquery.easy-pie-chart/jquery.easy-pie-chart.js"></script>
<script src="~/Content/vendor/flot/jquery.flot.js"></script>
<script src="~/Content/vendor/flot.tooltip/flot.tooltip.js"></script>
<script src="~/Content/vendor/flot/jquery.flot.pie.js"></script>
<script src="~/Content/vendor/flot/jquery.flot.categories.js"></script>
<script src="~/Content/vendor/flot/jquery.flot.resize.js"></script>
<script src="~/Content/vendor/jquery-sparkline/jquery-sparkline.js"></script>
<script src="~/Content/vendor/raphael/raphael.js"></script>
<script src="~/Content/vendor/morris/morris.js"></script>
<script src="~/Content/vendor/owl.carousel/owl.carousel.js"></script>
<script src="~/Content/vendor/chartist/chartist.js"></script>

<script src="~/Content/vendor/liquid-meter/liquid.meter.js"></script>
<script src="~/Content/vendor/snap.svg/snap.svg.js"></script>

<script src="~/Scripts/js/modernizr/2.8.3/modernizr.js"></script>

<!-- Theme Base, Components and Settings -->
<script src="~/Scripts/js/theme.js"></script>

<!-- Theme Custom -->
<script src="~/Scripts/js/custom.js"></script>

<!-- Theme Initialization Files -->
<script src="~/Scripts/js/theme.init.js"></script>
<!-- Examples -->
<script src="~/Scripts/js/examples/examples.widgets.js"></script>
<script src="~/Scripts/js/examples/examples.charts.js"></script>
<script src="~/Scripts/js/examples/examples.modals.js"></script>

